# 本番化に向けた修正箇所一覧

本プロジェクトを本番環境で運用するにあたり、セキュリティと設定の観点から以下の修正が必要です。

---

### 1. `docker-compose.yml`

- **データベースのパスワード**
  - `services.postgresql.environment.POSTGRES_PASSWORD`: 現在 `securepassword` に設定されています。本番環境では、より強力でランダムなパスワードに変更し、Docker Secretsなどの安全な方法で管理してください。
  - `services.authz-server.environment.SPRING_DATASOURCE_PASSWORD`: 同様に `securepassword` から変更し、安全に管理してください。

### 2. `src/main/resources/application.yml`

- **データベースのパスワード**
  - `spring.datasource.password`: 現在 `securepassword` に設定されています。開発用の設定であり、本番環境では `docker-compose.yml` の環境変数経由で設定されるべきですが、このファイルから削除するか、プロファイル機能（`application-prod.yml`）を使用して上書きすることを推奨します。

- **データベース初期化モード**
  - `spring.sql.init.mode`: 現在 `always` に設定されています。これは起動時に必ず `schema.sql` と `data.sql` を実行するため、本番環境では意図しないデータの上書きやリセットが発生する危険があります。本番環境では `never` に変更してください。

- **Issuer URI**
  - `issuer-uri`: 現在 `http://localhost:9000` に設定されています。本番環境では、外部に公開される正式なURL（例: `https://auth.example.com`）に変更する必要があります。

### 3. `src/main/java/com/example/internalauthzserver/config/SecurityConfig.java`

- **JWK (JSON Web Key) の生成方法**
  - `jwkSource()` メソッド内の `generateRsaKey()`: 現在、アプリケーション起動時にRSAキーペアをメモリ上で生成しています。これは開発用の簡易的な実装です。
  - **修正方針**: 本番環境では、KMS (Key Management Service) や HSM (Hardware Security Module) を使用して鍵を安全に管理し、そこから鍵を読み込むように実装を変更してください。鍵のローテーション（定期的な更新）も考慮する必要があります。

- **CORS (Cross-Origin Resource Sharing) ポリシー**
  - `corsConfigurationSource()`: 現在、`http://localhost:3000` からのアクセスを許可しています。
  - **修正方針**: 本番環境で連携するフロントエンドアプリケーションの正式なオリジン（URL）のみを許可するように、`config.addAllowedOrigin()` の値を変更してください。ワイルドカード(`*`)の使用は慎重に検討してください。

- **Issuer URI**
  - `issuerUri()`: 現在 `http://localhost:9000` をハードコードしています。
  - **修正方針**: `application.yml` の `issuer-uri` プロパティを `@Value` アノテーションなどを用いて読み込むように変更し、設定ファイルで一元管理できるようにすることを推奨します。

### 4. `src/main/resources/data.sql`

- **初期ユーザーのパスワード**
  - `t_users` テーブルに挿入されている `admin` および `user` のパスワードは、両方とも `'password'` です。
  - **修正方針**: 本番稼働前に、これらの初期ユーザーのパスワードをより強力なものに変更するか、初期ユーザー自体を削除し、運用開始後に正規の手順で管理者を作成してください。

- **初期クライアントのシークレット**
  - `oauth2_registered_client` テーブルに挿入されている `webapp-client` のクライアントシークレットは `'secret'` です。
  - **修正方針**: 本番稼動前に、このクライアントシークレットをより強力なものに変更してください。

---

これらの修正は、アプリケーションのセキュリティを確保し、本番環境で安定して運用するために不可欠です。
